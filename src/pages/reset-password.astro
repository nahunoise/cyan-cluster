---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Nueva Contraseña | The Creation Society">
  <main class="max-w-md mx-auto pt-32 px-6 text-center">
    <h1 class="text-4xl font-serif italic text-creation-gold mb-4">Nueva Contraseña</h1>
    <p class="text-white/50 text-xs mb-8 uppercase tracking-widest">Ingresa tu nueva clave de acceso</p>
    
    <div id="reset-form" class="space-y-4 text-left">
      <div>
        <label class="text-[10px] uppercase tracking-widest text-creation-gold/60">Nueva Contraseña</label>
        <input 
          type="password" 
          id="new-password" 
          placeholder="Mínimo 6 caracteres"
          required 
          class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl text-white outline-none focus:border-creation-gold mt-1" 
        />
      </div>
      
      <button id="btn-update" class="w-full bg-creation-gold text-creation-dark py-4 rounded-2xl font-bold hover:brightness-110 transition-all">
        Actualizar y Entrar
      </button>

      <div id="msg" class="text-xs pt-4 text-center min-h-[30px]"></div>
    </div>
  </main>
</Layout>

<script>
  import { supabase } from '../lib/supabase';

  const btnUpdate = document.getElementById('btn-update');
  const msg = document.getElementById('msg');
  const passwordInput = document.getElementById('new-password') as HTMLInputElement;

  btnUpdate?.addEventListener('click', async () => {
    const newPassword = passwordInput.value;

    if (newPassword.length < 6) {
      if (msg) {
        msg.textContent = "La contraseña debe tener al menos 6 caracteres.";
        msg.style.color = "#f87171";
      }
      return;
    }

    if (msg) msg.textContent = "Actualizando...";

    // Supabase detecta automáticamente el token que viene en la URL 
    // y permite esta actualización sin pedir la clave anterior.
    const { error } = await supabase.auth.updateUser({
      password: newPassword
    });

    if (error) {
      if (msg) {
        msg.textContent = `Error: ${error.message}`;
        msg.style.color = "#f87171";
      }
    } else {
      if (msg) {
        msg.textContent = "¡Contraseña actualizada! Redirigiendo...";
        msg.style.color = "#D4AF37";
      }
      // Pequeña pausa para que vean el mensaje de éxito antes de ir al dashboard
      setTimeout(() => {
        window.location.assign('/dashboard');
      }, 2000);
    }
  });
</script>