---
import Layout from '../layouts/Layout.astro';
---

<link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />

<Layout title="Dashboard | The Creation Society">
  <main id="dashboard-content" class="hidden max-w-7xl mx-auto px-4 md:px-6 pt-6 md:pt-10 pb-20 text-creation-cream">
    
    <nav class="mb-8 border-b border-white/5 pb-6">
      <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-6">
        <div class="flex flex-col md:flex-row md:items-center gap-4 md:gap-12">
          <h1 class="text-xl md:text-2xl font-serif italic text-creation-gold text-center md:text-left">The Creation Society</h1>
          <div class="flex gap-4 overflow-x-auto pb-2 md:pb-0 no-scrollbar justify-start md:justify-start px-2 md:px-0 scroll-smooth">
            <button class="path-tab active whitespace-nowrap" data-path="inicio">Inicio</button>
            <button class="path-tab whitespace-nowrap" data-path="creation">Creation</button>
            <button class="path-tab whitespace-nowrap" data-path="impact">Impact</button>
            <button class="path-tab whitespace-nowrap" data-path="founder">Founder</button>
            <button class="path-tab border-l border-white/10 pl-4 text-white/40 whitespace-nowrap" data-path="perfil">Perfil</button>
            <button class="path-tab whitespace-nowrap" data-path="comunidad">Comunidad</button>
          </div>
        </div>
        <div class="flex items-center justify-center md:justify-end gap-3">
          <a href="https://discord.gg/y2BVDrj6" target="_blank" class="text-[9px] md:text-[10px] bg-[#5865F2] text-white px-4 py-2 rounded-full font-bold hover:brightness-110 transition-all flex items-center gap-2">DISCORD LIVE</a>
          <button id="logout" class="text-[9px] md:text-[10px] uppercase border border-white/10 px-4 py-2 rounded-full hover:bg-white/5 transition-all">Salir</button>
        </div>
      </div>
    </nav>

   <div id="view-learning" class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
      <div class="lg:col-span-8 space-y-8">
        <div class="rounded-2xl md:rounded-3xl border border-white/10 overflow-hidden shadow-2xl bg-black aspect-video">
          <div id="player" data-plyr-provider="youtube" data-plyr-embed-id="UIByRox2g6k"></div>
        </div>
        
        <div class="space-y-4 px-2 md:px-0">
          <h2 id="v-title" class="text-2xl md:text-3xl font-serif italic text-creation-gold">Bienvenida</h2>
          <div id="v-desc" class="text-white/50 text-sm max-w-2xl leading-relaxed italic text-pretty">Selecciona una clase para comenzar a construir.</div>
        </div>

        <div class="mt-12 pt-10 border-t border-white/5 space-y-6">
          <h3 class="font-serif italic text-xl text-creation-gold">Conversación</h3>
          <div class="flex gap-4">
            <div class="w-10 h-10 rounded-full bg-white/5 border border-white/10 flex items-center justify-center shrink-0 text-xs text-creation-gold">You</div>
            <div class="flex-1 space-y-3">
              <textarea id="comment-input" placeholder="Deja un pensamiento..." class="w-full bg-white/[0.03] border border-white/10 rounded-2xl p-4 text-sm text-white outline-none focus:border-creation-gold transition-all resize-none h-24"></textarea>
              <button id="send-comment" class="bg-white/5 border border-white/10 px-6 py-2 rounded-full text-[10px] font-bold uppercase hover:bg-creation-gold hover:text-black transition-all">Publicar</button>
            </div>
          </div>
          <div id="comments-container" class="space-y-6 mt-8"></div>
        </div>
      </div>

      <div class="lg:col-span-4 space-y-6">
        <div class="bg-white/[0.02] border border-white/5 rounded-2xl overflow-hidden flex flex-col max-h-[450px]">
          <div class="p-4 border-b border-white/5 bg-white/[0.02]">
            <p id="path-label" class="text-[10px] uppercase tracking-[0.2em] text-creation-gold font-bold">Contenido Actual</p>
          </div>
          <div id="path-container" class="overflow-y-auto p-3 space-y-2 custom-scrollbar"></div>
        </div>
      </div>
    </div>

    <div id="view-comunidad" class="hidden animate-in fade-in slide-in-from-bottom-4 duration-500 max-w-6xl mx-auto">
      <div class="mb-10 text-center">
        <h2 class="text-3xl font-serif italic text-creation-gold">Builders Ecosystem</h2>
        <p class="text-white/40 text-sm mt-2">Conoce a los creadores que están construyendo el futuro.</p>
      </div>
      <div id="community-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        </div>
    </div>

    <div id="view-perfil" class="hidden max-w-xl mx-auto py-10 px-2">
        <div class="bg-white/[0.02] border border-white/5 p-10 rounded-[40px] shadow-2xl">
            <div class="flex flex-col items-center text-center mb-10">
              <div class="w-16 h-16 bg-creation-gold/10 rounded-full flex items-center justify-center border border-creation-gold/20 mb-4">
                <span class="text-creation-gold text-xl font-serif">CS</span>
              </div>
              <h2 class="text-2xl font-serif italic text-creation-gold">Ajustes de Cuenta</h2>
              <p id="user-email-display" class="text-white/30 text-[11px] font-mono mt-2 uppercase tracking-widest"></p>
            </div>
<div class="space-y-6">
  <div class="space-y-2">
    <label class="text-[10px] uppercase tracking-[0.2em] text-creation-gold font-bold ml-1">Nombre Público</label>
    <input type="text" id="profile-name" placeholder="Tu nombre" class="w-full bg-black/40 border border-white/10 rounded-2xl px-5 py-4 text-sm focus:border-creation-gold outline-none text-white" />
  </div>

  <div class="space-y-2">
    <label class="text-[10px] uppercase tracking-[0.2em] text-creation-gold font-bold ml-1">Biografía Corta</label>
    <input type="text" id="profile-bio" placeholder="Ej: Diseñador y entusiasta de la IA" class="w-full bg-black/40 border border-white/10 rounded-2xl px-5 py-4 text-sm focus:border-creation-gold outline-none text-white" />
  </div>

  <div class="space-y-2">
    <label class="text-[10px] uppercase tracking-[0.2em] text-creation-gold font-bold ml-1">Tu Proyecto</label>
    <textarea id="profile-project" placeholder="¿Qué estás construyendo en The Creation Society?" class="w-full bg-black/40 border border-white/10 rounded-2xl px-5 py-4 text-sm focus:border-creation-gold outline-none text-white resize-none h-24"></textarea>
  </div>

  <div class="space-y-2">
    <label class="text-[10px] uppercase tracking-[0.2em] text-creation-gold font-bold ml-1">LinkedIn URL</label>
    <input type="url" id="profile-linkedin" placeholder="https://linkedin.com/in/tu-usuario" class="w-full bg-black/40 border border-white/10 rounded-2xl px-5 py-4 text-sm focus:border-creation-gold outline-none text-white" />
  </div>
  
  <button id="update-profile-data" class="w-full bg-creation-gold text-black text-[11px] uppercase font-bold py-4 rounded-2xl hover:brightness-110 transition-all">
    Guardar Perfil de Creador
  </button>
  
  <p id="profile-msg" class="text-[10px] mt-4 text-center italic hidden"></p>
</div>


            <div class="space-y-6">
              <input type="password" id="new-password" placeholder="Nueva contraseña" class="w-full bg-black/40 border border-white/10 rounded-2xl px-5 py-4 text-sm text-white outline-none focus:border-creation-gold" />
              <button id="update-pw" class="w-full bg-white/5 border border-white/10 text-white text-[11px] uppercase font-bold py-4 rounded-2xl hover:bg-creation-gold hover:text-black transition-all">Actualizar Contraseña</button>
              <p id="pw-msg" class="text-[10px] mt-4 text-center italic hidden"></p>
            </div>
        </div>
    </div>
  </main>
</Layout>

<script>
  import { supabase } from '../lib/supabase';
  import Plyr from 'plyr';

  // --- 1. VARIABLES GLOBALES (Estado de la App) ---
  let player;
  let currentVideoId = 'UIByRox2g6k';
  let currentUserEmail = '';
  let currentUserId = ''; // <--- ESTA ES LA CLAVE

  const content = {
    inicio: [
        { title: 'Bienvenida', desc: 'Bienvenido al programa.', videoId: 'UIByRox2g6k' },
        { title: 'El valor del autoaprendizaje', desc: 'Reflexiones fundamentales.', videoId: 'gq8MR_JuRG0' },
    ],
    creation: [
        { title: 'Setup Builders', desc: 'Instalación de VS Code.', videoId: 'wlajYcIHipA' },
        { title: 'Astro Framework', desc: 'Iniciando con Astro.', videoId: 'u7idp69s-TM' },
    ],
    impact: [
        { title: 'Fundamentos', desc: 'Impacto social real.', videoId: 'V9S7I7R8x90' },
    ],
    founder: [
        { title: 'Mindset Builder', desc: 'Mentalidad de creador.', videoId: 'M93S8I7R8x0' },
    ],
  };

  // --- 2. FUNCIONES DE CARGA (Comments, Profile, Video) ---

  async function loadComments(videoId) {
    const container = document.getElementById('comments-container');
    if (!container) return;
    
    const { data, error } = await supabase
      .from('comments')
      .select(`content, created_at, profiles ( full_name )`)
      .eq('video_id', videoId)
      .order('created_at', { ascending: false });

    if (error) return console.error(error);

    container.innerHTML = data.map(c => `
      <div class="flex gap-4 animate-in fade-in duration-500">
        <div class="w-10 h-10 rounded-full bg-creation-gold/10 border border-creation-gold/20 flex items-center justify-center shrink-0 text-[10px] text-creation-gold font-bold">
          ${c.profiles?.full_name?.substring(0,2).toUpperCase() || '??'}
        </div>
        <div class="flex-1">
          <div class="flex items-center gap-3">
            <p class="text-[11px] font-bold text-creation-gold/80">${c.profiles?.full_name || 'Usuario Anónimo'}</p>
            <p class="text-[9px] text-white/20 uppercase">${new Date(c.created_at).toLocaleDateString()}</p>
          </div>
          <p class="text-sm text-white/70">${c.content}</p>
        </div>
      </div>
    `).join('');
  }

  async function loadProfileData(userId) {
    const { data } = await supabase.from('profiles').select('*').eq('id', userId).single();
    if (data) {
      (document.getElementById('profile-name') as HTMLInputElement).value = data.full_name || '';
      (document.getElementById('profile-bio') as HTMLInputElement).value = data.bio || '';
      (document.getElementById('profile-project') as HTMLTextAreaElement).value = data.project_description || '';
      (document.getElementById('profile-linkedin') as HTMLInputElement).value = data.linkedin_url || '';
    }
  }

  // --- 3. EVENTOS DE BOTONES (Click Listeners) ---

  // Botón Publicar Comentario
  document.getElementById('send-comment')?.addEventListener('click', async () => {
    const input = document.getElementById('comment-input') as HTMLTextAreaElement;
    const contentText = input.value.trim();
    
    if (!contentText || !currentUserId) return;

    const { error } = await supabase.from('comments').insert([
      { 
        video_id: currentVideoId, 
        content: contentText,
        user_id: currentUserId,
        user_email: currentUserEmail 
      }
    ]);

    if (!error) {
      input.value = '';
      loadComments(currentVideoId);
    } else {
      console.error("Error al comentar:", error.message);
    }
  });

  // Botón Guardar Perfil
  document.getElementById('update-profile-data')?.addEventListener('click', async () => {
    const name = (document.getElementById('profile-name') as HTMLInputElement).value;
    const bio = (document.getElementById('profile-bio') as HTMLInputElement).value;
    const project = (document.getElementById('profile-project') as HTMLTextAreaElement).value;
    const linkedin = (document.getElementById('profile-linkedin') as HTMLInputElement).value;
    const msg = document.getElementById('profile-msg');

    const { error } = await supabase.from('profiles').upsert({
      id: currentUserId,
      full_name: name,
      bio: bio,
      project_description: project,
      linkedin_url: linkedin,
      updated_at: new Date()
    });

    if (msg) {
      msg.innerText = error ? "Error al guardar" : "✓ Perfil actualizado";
      msg.style.color = error ? "#f87171" : "#D4AF37";
      msg.classList.remove('hidden');
    }
  });

  // --- 4. INICIALIZACIÓN ---

  async function init() {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) return window.location.assign('/login');
    
    // ASIGNACIÓN DE SESIÓN A VARIABLES GLOBALES
    currentUserId = session.user.id;
    currentUserEmail = session.user.email ?? '';

    document.getElementById('dashboard-content')?.classList.remove('hidden');
    if (document.getElementById('user-email-display')) {
      document.getElementById('user-email-display')!.innerText = currentUserEmail;
    }

    player = new Plyr('#player', { controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'fullscreen'] });
    
    renderPath('inicio');
    loadComments(currentVideoId);
    loadProfileData(currentUserId);
  }

  // Las funciones window.playVideo y renderPath van aquí igual que antes...
  window.playVideo = (path, idx) => {
    const item = content[path][idx];
    currentVideoId = item.videoId;
    player.source = { type: 'video', sources: [{ src: item.videoId, provider: 'youtube' }] };
    player.play();
    document.getElementById('v-title')!.innerText = item.title;
    document.getElementById('v-desc')!.innerHTML = item.desc;
    loadComments(currentVideoId);
  };

  function renderPath(pathKey) {
    const container = document.getElementById('path-container');
    if (!container) return;
    container.innerHTML = content[pathKey].map((c, i) => `
      <button onclick="window.playVideo('${pathKey}', ${i})" class="video-card w-full text-left p-3 rounded-2xl flex items-center gap-3 group">
        <div class="w-6 h-6 rounded-full bg-white/5 flex items-center justify-center text-[8px] font-bold text-creation-gold group-hover:bg-creation-gold transition-all shrink-0">${i+1}</div>
        <h4 class="text-[12px] font-bold text-white/70 group-hover:text-white">${c.title}</h4>
      </button>
    `).join('');
  }

  init();

  // Tabs navigation
// --- NAVEGACIÓN DE VISTAS ACTUALIZADA ---
  const tabs = document.querySelectorAll('.path-tab');
  
  // Referencias a las secciones
  const viewLearning = document.getElementById('view-learning');
  const viewPerfil = document.getElementById('view-perfil');
  const viewComunidad = document.getElementById('view-comunidad');

  tabs.forEach(tab => {
    tab.addEventListener('click', (e) => {
      const path = (e.target as HTMLElement).dataset.path;

      // 1. Gestionar clases de los botones (el subrayado dorado)
      tabs.forEach(t => t.classList.remove('active'));
      (e.target as HTMLElement).classList.add('active');

      // 2. Ocultar TODAS las vistas primero para "limpiar" la pantalla
      viewLearning?.classList.add('hidden');
      viewPerfil?.classList.add('hidden');
      viewComunidad?.classList.add('hidden');

      // 3. Mostrar la vista que corresponde
      if (path === 'perfil') {
        viewPerfil?.classList.remove('hidden');
      } 
      else if (path === 'comunidad') {
        viewComunidad?.classList.remove('hidden');
        loadCommunity(); // Llamamos a la función para cargar los perfiles
      } 
      else {
        // Si no es perfil ni comunidad, es una de las rutas de aprendizaje (inicio, creation, etc.)
        viewLearning?.classList.remove('hidden');
        if (path) renderPath(path);
      }
    });
  });

  async function loadCommunity() {
    const grid = document.getElementById('community-grid');
    if (!grid) return;

    // Limpiamos el grid para mostrar que está cargando
    grid.innerHTML = '<p class="text-creation-gold animate-pulse text-center col-span-full uppercase text-[10px] tracking-widest">Cargando ecosistema...</p>';

    const { data, error } = await supabase
      .from('profiles')
      .select('*')
      .not('full_name', 'is', null) // Solo gente con nombre
      .order('updated_at', { ascending: false });

    if (error) {
      console.error(error);
      grid.innerHTML = '<p class="text-red-400">Error al cargar la comunidad.</p>';
      return;
    }

    grid.innerHTML = data.map(profile => `
      <div class="bg-white/[0.02] border border-white/5 p-6 rounded-[32px] hover:border-creation-gold/30 transition-all group">
        <div class="flex items-start justify-between mb-4">
          <div class="w-12 h-12 rounded-2xl bg-creation-gold/10 border border-creation-gold/20 flex items-center justify-center text-creation-gold font-bold">
            ${profile.full_name?.substring(0,2).toUpperCase() || '??'}
          </div>
          ${profile.linkedin_url ? `
            <a href="${profile.linkedin_url}" target="_blank" class="text-white/20 hover:text-creation-gold transition-colors">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
            </a>
          ` : ''}
        </div>
        <h3 class="text-lg font-serif italic text-white group-hover:text-creation-gold transition-colors">${profile.full_name}</h3>
        <p class="text-[10px] uppercase tracking-widest text-creation-gold/60 font-bold mb-3">${profile.bio || 'Builder'}</p>
        <div class="pt-4 border-t border-white/5">
          <p class="text-[11px] text-white/40 uppercase tracking-tighter mb-1">Proyecto:</p>
          <p class="text-sm text-white/70 italic line-clamp-3">${profile.project_description || 'En desarrollo...'}</p>
        </div>
      </div>
    `).join('');
  }
</script>

<style is:global>
  :root { --plyr-color-main: #D4AF37; }
  .path-tab { @apply text-[10px] uppercase tracking-widest font-bold text-white/30 transition-all border-b-2 border-transparent pb-1 cursor-pointer hover:text-white/60 shrink-0; }
  .path-tab.active { @apply text-creation-gold border-creation-gold; }
  .active-card { @apply bg-white/[0.06] border-white/10 !important; }
  .active-card h4 { @apply text-creation-gold; }
  .custom-scrollbar::-webkit-scrollbar { width: 4px; }
  .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(212, 175, 55, 0.2); border-radius: 10px; }
  .no-scrollbar::-webkit-scrollbar { display: none; }
  .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
</style>