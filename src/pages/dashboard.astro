---
import Layout from '../layouts/Layout.astro';
---

<link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />

<Layout title="Dashboard | The Creation Society">
  <main id="dashboard-content" class="hidden max-w-7xl mx-auto px-4 md:px-6 pt-6 md:pt-10 pb-20 text-creation-cream">
    
    <nav class="mb-8 border-b border-white/5 pb-6">
      <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-6">
        <div class="flex flex-col md:flex-row md:items-center gap-4 md:gap-12">
          <h1 class="text-xl md:text-2xl font-serif italic text-creation-gold text-center md:text-left">The Creation Society</h1>
          <div class="flex gap-4 overflow-x-auto pb-2 md:pb-0 no-scrollbar justify-start md:justify-start px-2 md:px-0 scroll-smooth">
            <button class="path-tab active whitespace-nowrap" data-path="inicio">Inicio</button>
            <button class="path-tab whitespace-nowrap" data-path="creation">Creation</button>
            <button class="path-tab whitespace-nowrap" data-path="impact">Impact</button>
            <button class="path-tab whitespace-nowrap" data-path="founder">Founder</button>
            <button class="path-tab border-l border-white/10 pl-4 text-white/40 whitespace-nowrap" data-path="perfil">Perfil</button>
          </div>
        </div>
        <div class="flex items-center justify-center md:justify-end gap-3">
          <a href="https://discord.gg/y2BVDrj6" target="_blank" class="text-[9px] md:text-[10px] bg-[#5865F2] text-white px-4 py-2 rounded-full font-bold hover:brightness-110 transition-all flex items-center gap-2">DISCORD LIVE</a>
          <button id="logout" class="text-[9px] md:text-[10px] uppercase border border-white/10 px-4 py-2 rounded-full hover:bg-white/5 transition-all">Salir</button>
        </div>
      </div>
    </nav>

    <div id="view-learning" class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
      <div class="lg:col-span-8 space-y-8">
        <div class="rounded-2xl md:rounded-3xl border border-white/10 overflow-hidden shadow-2xl bg-black aspect-video">
          <div id="player" data-plyr-provider="youtube" data-plyr-embed-id="UIByRox2g6k"></div>
        </div>
        
        <div class="space-y-4 px-2 md:px-0">
          <h2 id="v-title" class="text-2xl md:text-3xl font-serif italic text-creation-gold">Bienvenida</h2>
          <div id="v-desc" class="text-white/50 text-sm max-w-2xl leading-relaxed italic text-pretty">Selecciona una clase para comenzar a construir.</div>
          
          <div id="v-resources" class="pt-6 border-t border-white/5 hidden">
            <p class="text-[10px] uppercase tracking-[0.2em] text-creation-gold font-bold mb-4">Recursos de la sesión</p>
            <div id="resources-list" class="flex flex-wrap gap-3"></div>
          </div>
        </div>

        <div class="mt-12 pt-10 border-t border-white/5 space-y-6">
          <h3 class="font-serif italic text-xl text-creation-gold">Conversación</h3>
          
          <div class="flex gap-4">
            <div class="w-10 h-10 rounded-full bg-white/5 border border-white/10 flex items-center justify-center shrink-0 text-xs text-creation-gold">You</div>
            <div class="flex-1 space-y-3">
              <textarea id="comment-input" placeholder="Deja un pensamiento o duda..." class="w-full bg-white/[0.03] border border-white/10 rounded-2xl p-4 text-sm text-white outline-none focus:border-creation-gold transition-all resize-none h-24"></textarea>
              <button id="send-comment" class="bg-white/5 border border-white/10 px-6 py-2 rounded-full text-[10px] font-bold uppercase hover:bg-creation-gold hover:text-black transition-all">Publicar</button>
            </div>
          </div>

          <div id="comments-container" class="space-y-6 mt-8">
            </div>
        </div>
      </div>

      <div class="lg:col-span-4 space-y-6">
        <div class="bg-white/[0.02] border border-white/5 rounded-2xl md:rounded-3xl overflow-hidden flex flex-col max-h-[400px] md:max-h-[450px]">
          <div class="p-4 border-b border-white/5 bg-white/[0.02]">
            <p id="path-label" class="text-[10px] uppercase tracking-[0.2em] text-creation-gold font-bold">Contenido Actual</p>
          </div>
          <div id="path-container" class="overflow-y-auto p-3 space-y-2 custom-scrollbar"></div>
        </div>

        <div class="bg-white/[0.02] border border-white/5 p-6 rounded-2xl md:rounded-3xl">
          <h3 class="text-creation-gold font-serif italic text-lg mb-4">Próximos Eventos</h3>
          <div class="space-y-4">
             <div class="flex items-center gap-4 border-l border-creation-gold/30 pl-3">
              <div class="text-left">
                <p class="text-creation-gold text-[9px] font-bold uppercase leading-none">ENE 29</p>
                <p class="text-[11px] text-white/80 mt-1">Kickoff Piloto</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="view-perfil" class="hidden max-w-xl mx-auto py-10 px-2">
        <div class="bg-white/[0.02] border border-white/5 p-10 rounded-[40px] shadow-2xl">
            <div class="flex flex-col items-center text-center mb-10">
              <div class="w-16 h-16 bg-creation-gold/10 rounded-full flex items-center justify-center border border-creation-gold/20 mb-4">
                <span class="text-creation-gold text-xl font-serif">CS</span>
              </div>
              <h2 class="text-2xl font-serif italic text-creation-gold">Ajustes de Cuenta</h2>
              <p id="user-email-display" class="text-white/30 text-[11px] font-mono mt-2 uppercase tracking-widest"></p>
            </div>
            <div class="space-y-6">
              <input type="password" id="new-password" placeholder="Nueva contraseña" class="w-full bg-black/40 border border-white/10 rounded-2xl px-5 py-4 text-sm text-white outline-none focus:border-creation-gold" />
              <button id="update-pw" class="w-full bg-white/5 border border-white/10 text-white text-[11px] uppercase font-bold py-4 rounded-2xl hover:bg-creation-gold hover:text-black transition-all">Actualizar Contraseña</button>
              <p id="pw-msg" class="text-[10px] mt-4 text-center italic hidden"></p>
            </div>
        </div>
    </div>
  </main>
</Layout>

<script>
  import { supabase } from '../lib/supabase';
  import Plyr from 'plyr';

  // --- DATOS ---
  const content = {
    inicio: [
        { title: 'Bienvenida', desc: 'Bienvenido al programa.', videoId: 'UIByRox2g6k' },
        { title: 'El valor del autoaprendizaje', desc: 'Reflexiones fundamentales.', videoId: 'gq8MR_JuRG0' },
    ],
    creation: [
        { title: 'Setup Builders', desc: 'Instalación de VS Code.', videoId: 'wlajYcIHipA' },
        { title: 'Astro Framework', desc: 'Iniciando con Astro.', videoId: 'u7idp69s-TM' },
    ],
    impact: [
        { title: 'Fundamentos', desc: 'Impacto social real.', videoId: 'V9S7I7R8x90' },
    ],
    founder: [
        { title: 'Mindset Builder', desc: 'Mentalidad de creador.', videoId: 'M93S8I7R8x0' },
    ],
  };

  let player;
  let currentVideoId = 'UIByRox2g6k';
  let currentUserEmail = '';

  // --- NAVEGACIÓN VISTAS ---
  const tabs = document.querySelectorAll('.path-tab');
  const viewLearning = document.getElementById('view-learning');
  const viewPerfil = document.getElementById('view-perfil');

  tabs.forEach(tab => {
    tab.addEventListener('click', (e) => {
      const path = (e.target as HTMLElement).dataset.path;
      tabs.forEach(t => t.classList.remove('active'));
      (e.target as HTMLElement).classList.add('active');
      if (path === 'perfil') {
        viewLearning?.classList.add('hidden');
        viewPerfil?.classList.remove('hidden');
      } else {
        viewPerfil?.classList.add('hidden');
        viewLearning?.classList.remove('hidden');
        if (path) renderPath(path);
      }
    });
  });

  // --- COMENTARIOS (Lógica) ---
  async function loadComments(videoId) {
    const container = document.getElementById('comments-container');
    if (!container) return;
    
    const { data, error } = await supabase
      .from('comments')
      .select('*')
      .eq('video_id', videoId)
      .order('created_at', { ascending: false });

    if (error) return console.error(error);

    container.innerHTML = data.length ? data.map(c => `
      <div class="flex gap-4 group animate-in slide-in-from-bottom-2 duration-300">
        <div class="w-10 h-10 rounded-full bg-creation-gold/10 border border-creation-gold/20 flex items-center justify-center shrink-0 text-[10px] text-creation-gold font-bold">
          ${c.user_email.substring(0,2).toUpperCase()}
        </div>
        <div class="flex-1 space-y-1">
          <div class="flex items-center gap-3">
            <p class="text-[11px] font-bold text-creation-gold/80">${c.user_email}</p>
            <p class="text-[9px] text-white/20 uppercase tracking-tighter">${new Date(c.created_at).toLocaleDateString()}</p>
          </div>
          <p class="text-sm text-white/70 leading-relaxed">${c.content}</p>
        </div>
      </div>
    `).join('') : `<p class="text-white/20 text-xs italic text-center py-10">Nadie ha comentado aún. Sé el primero.</p>`;
  }

  document.getElementById('send-comment')?.addEventListener('click', async () => {
    const input = document.getElementById('comment-input') as HTMLTextAreaElement;
    const contentText = input.value.trim();
    if (!contentText) return;

    const { error } = await supabase.from('comments').insert([
      { video_id: currentVideoId, user_email: currentUserEmail, content: contentText }
    ]);

    if (!error) {
      input.value = '';
      loadComments(currentVideoId);
    }
  });

  // --- VIDEO Y PLAYLIST ---
  window.playVideo = (path, idx) => {
    const item = content[path][idx];
    currentVideoId = item.videoId;
    player.source = { type: 'video', sources: [{ src: item.videoId, provider: 'youtube' }] };
    player.play();
    
    document.getElementById('v-title')!.innerText = item.title;
    document.getElementById('v-desc')!.innerHTML = item.desc;
    
    loadComments(currentVideoId);

    document.querySelectorAll('.video-card').forEach(c => c.classList.remove('active-card'));
    document.getElementById(`card-${path}-${idx}`)?.classList.add('active-card');
  };

  function renderPath(pathKey) {
    const container = document.getElementById('path-container');
    const label = document.getElementById('path-label');
    if (!container || pathKey === 'perfil') return;
    label!.innerText = pathKey.toUpperCase() + " PATH";
    container.innerHTML = content[pathKey].map((c, i) => `
      <button id="card-${pathKey}-${i}" onclick="window.playVideo('${pathKey}', ${i})" 
        class="video-card w-full text-left p-3 rounded-2xl border border-transparent hover:bg-white/[0.04] transition-all flex items-center gap-3 group"
      >
        <div class="w-6 h-6 rounded-full bg-white/5 flex items-center justify-center text-[8px] font-bold text-creation-gold group-hover:bg-creation-gold transition-all shrink-0">
          ${(i + 1).toString().padStart(2, '0')}
        </div>
        <div class="flex-1">
          <h4 class="text-[12px] font-bold text-white/70 group-hover:text-white transition-colors leading-tight">${c.title}</h4>
        </div>
      </button>
    `).join('');
  }

  // --- INIT ---
  async function init() {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) return window.location.assign('/login');
    document.getElementById('dashboard-content')?.classList.remove('hidden');
    
    currentUserEmail = session.user.email ?? '';
    if (document.getElementById('user-email-display')) {
      document.getElementById('user-email-display')!.innerText = currentUserEmail;
    }

    player = new Plyr('#player', { controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'fullscreen'] });
    
    renderPath('inicio');
    loadComments(currentVideoId);
  }

  init();

  // (Logout y Password Update se mantienen igual que tu versión anterior)
  document.getElementById('logout')?.addEventListener('click', async () => {
    await supabase.auth.signOut();
    window.location.href = '/login';
  });
</script>

<style is:global>
  :root { --plyr-color-main: #D4AF37; }
  .path-tab { @apply text-[10px] uppercase tracking-widest font-bold text-white/30 transition-all border-b-2 border-transparent pb-1 cursor-pointer hover:text-white/60 shrink-0; }
  .path-tab.active { @apply text-creation-gold border-creation-gold; }
  .active-card { @apply bg-white/[0.06] border-white/10 !important; }
  .active-card h4 { @apply text-creation-gold; }
  .custom-scrollbar::-webkit-scrollbar { width: 4px; }
  .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(212, 175, 55, 0.2); border-radius: 10px; }
  .no-scrollbar::-webkit-scrollbar { display: none; }
  .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
</style>