---
import Layout from '../layouts/Layout.astro';
---

<link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />

<Layout title="Dashboard | The Creation Society">
  <main id="dashboard-content" class="hidden max-w-7xl mx-auto px-4 md:px-6 pt-6 md:pt-10 pb-20 text-creation-cream">
    
    <nav class="mb-8 border-b border-white/5 pb-6">
      <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-6">
        <div class="flex flex-col md:flex-row md:items-center gap-4 md:gap-12">
          <h1 class="text-xl md:text-2xl font-serif italic text-creation-gold text-center md:text-left">The Creation Society</h1>
          <div class="flex gap-4 overflow-x-auto pb-2 md:pb-0 no-scrollbar justify-start md:justify-start px-2 md:px-0 scroll-smooth">
            <button class="path-tab active whitespace-nowrap" data-path="inicio">Inicio</button>
            <button class="path-tab whitespace-nowrap" data-path="creation">Creation</button>
            <button class="path-tab whitespace-nowrap" data-path="impact">Impact</button>
            <button class="path-tab whitespace-nowrap" data-path="founder">Founder</button>
            <button class="path-tab border-l border-white/10 pl-4 text-white/40 whitespace-nowrap" data-path="perfil">Perfil</button>
            <button class="path-tab whitespace-nowrap" data-path="comunidad">Comunidad</button>
          </div>
        </div>
        <div class="flex items-center justify-center md:justify-end gap-3">
          <a href="https://discord.gg/HMwxQtky" target="_blank" class="text-[9px] md:text-[10px] bg-[#5865F2] text-white px-4 py-2 rounded-full font-bold hover:brightness-110 transition-all flex items-center gap-2">DISCORD LIVE</a>
          <button id="logout" class="text-[9px] md:text-[10px] uppercase border border-white/10 px-4 py-2 rounded-full hover:bg-white/5 transition-all">Salir</button>
        </div>
      </div>
    </nav>

    <div id="view-learning" class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
      <div class="lg:col-span-8 space-y-8">
        <div class="rounded-2xl md:rounded-3xl border border-white/10 overflow-hidden shadow-2xl bg-black aspect-video">
          <div id="player" data-plyr-provider="youtube" data-plyr-embed-id="UIByRox2g6k"></div>
        </div>
        
        
        <div class="space-y-4 px-2 md:px-0">
          <div class="flex items-center gap-2 opacity-40">
            <span id="v-track-label" class="text-[10px] uppercase tracking-[0.3em] font-bold">Inicio</span>
            <span class="text-[10px]">/</span>
            <span id="v-index-label" class="text-[10px] uppercase tracking-[0.3em]">Lección 1</span>
          </div>
          <h2 id="v-title" class="text-2xl md:text-3xl font-serif italic text-creation-gold">Bienvenida</h2>
          <div id="v-desc" class="text-white/50 text-sm max-w-2xl leading-relaxed italic text-pretty">Selecciona una clase para comenzar.</div>
          
          <div class="pt-6">
            <button id="next-video-btn" class="group flex items-center gap-3 bg-white/5 border border-white/10 px-8 py-3 rounded-full hover:bg-creation-gold hover:text-black transition-all duration-500">
              <span class="text-[10px] uppercase tracking-[0.2em] font-bold">Continuar lección</span>
              <svg class="w-4 h-4 transform group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
            </button>
          </div>
        </div>

        <div class="mt-12 pt-10 border-t border-white/5 space-y-6">
          <h3 class="font-serif italic text-xl text-creation-gold">Conversación</h3>
          <div class="flex gap-4">
            <div class="w-10 h-10 rounded-full bg-white/5 border border-white/10 flex items-center justify-center shrink-0 text-xs text-creation-gold font-bold">YOU</div>
            <div class="flex-1 space-y-3">
              <textarea id="comment-input" placeholder="Deja un pensamiento..." class="w-full bg-white/[0.03] border border-white/10 rounded-2xl p-4 text-sm text-white outline-none focus:border-creation-gold transition-all resize-none h-24"></textarea>
              <button id="send-comment" class="bg-white/5 border border-white/10 px-6 py-2 rounded-full text-[10px] font-bold uppercase hover:bg-creation-gold hover:text-black transition-all">Publicar</button>
            </div>
          </div>
          <div id="comments-container" class="space-y-6 mt-8"></div>
        </div>
      </div>

      <div class="lg:col-span-4 space-y-6">
        <div class="bg-white/[0.02] border border-white/5 rounded-2xl overflow-hidden flex flex-col max-h-[450px]">
          <div class="p-4 border-b border-white/5 bg-white/[0.02]">
            <p id="path-label" class="text-[10px] uppercase tracking-[0.2em] text-creation-gold font-bold">Contenido Actual</p>
          </div>
          <div id="path-container" class="overflow-y-auto p-3 space-y-2 custom-scrollbar"></div>
        </div>
      </div>
    </div>

    <div id="view-comunidad" class="hidden animate-in fade-in slide-in-from-bottom-4 duration-500 max-w-6xl mx-auto">
      <div class="mb-10 text-center">
        <h2 class="text-3xl font-serif italic text-creation-gold">Builders Ecosystem</h2>
        <p class="text-white/40 text-sm mt-2">Conoce a los creadores que están construyendo el futuro.</p>
      </div>
      <div id="community-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </div>

    <div id="view-perfil" class="hidden max-w-xl mx-auto py-10 px-2">
        <div class="bg-white/[0.02] border border-white/5 p-10 rounded-[40px] shadow-2xl">
            <div class="flex flex-col items-center text-center mb-10">
              <div class="w-16 h-16 bg-creation-gold/10 rounded-full flex items-center justify-center border border-creation-gold/20 mb-4">
                <span class="text-creation-gold text-xl font-serif">CS</span>
              </div>
              <h2 class="text-2xl font-serif italic text-creation-gold">Ajustes de Cuenta</h2>
              <p id="user-email-display" class="text-white/30 text-[11px] font-mono mt-2 uppercase tracking-widest"></p>
            </div>
            <div class="space-y-6">
                <div class="space-y-2">
                    <label class="text-[10px] uppercase tracking-[0.2em] text-creation-gold font-bold">Nombre Público</label>
                    <input type="text" id="profile-name" class="w-full bg-black/40 border border-white/10 rounded-2xl px-5 py-4 text-sm focus:border-creation-gold outline-none text-white" />
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] uppercase tracking-[0.2em] text-creation-gold font-bold">Biografía Corta</label>
                    <input type="text" id="profile-bio" class="w-full bg-black/40 border border-white/10 rounded-2xl px-5 py-4 text-sm focus:border-creation-gold outline-none text-white" />
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] uppercase tracking-[0.2em] text-creation-gold font-bold">Tu Proyecto</label>
                    <textarea id="profile-project" class="w-full bg-black/40 border border-white/10 rounded-2xl px-5 py-4 text-sm focus:border-creation-gold outline-none text-white resize-none h-24"></textarea>
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] uppercase tracking-[0.2em] text-creation-gold font-bold">LinkedIn URL</label>
                    <input type="url" id="profile-linkedin" class="w-full bg-black/40 border border-white/10 rounded-2xl px-5 py-4 text-sm focus:border-creation-gold outline-none text-white" placeholder="https://linkedin.com/in/..." />
                </div>

                <div class="pt-4 border-t border-white/5 space-y-4">
                  <div class="space-y-2">
                      <label class="text-[10px] uppercase tracking-[0.2em] text-creation-gold font-bold">Nueva Contraseña</label>
                      <input type="password" id="profile-password" class="w-full bg-black/40 border border-white/10 rounded-2xl px-5 py-4 text-sm focus:border-creation-gold outline-none text-white" placeholder="Dejar en blanco para no cambiar" />
                  </div>
                </div>

                <button id="update-profile-data" class="w-full bg-creation-gold text-black text-[11px] uppercase font-bold py-4 rounded-2xl hover:brightness-110 transition-all">Guardar Perfil</button>
                <p id="profile-msg" class="text-[10px] mt-4 text-center italic hidden"></p>
            </div>
        </div>
    </div>
  </main>
</Layout>

<script>
  import { supabase } from '../lib/supabase';
  import Plyr from 'plyr';

  // --- VARIABLES DE ESTADO ---
  let player;
  let currentVideoId = 'UIByRox2g6k';
  let currentUserEmail = '';
  let currentUserId = '';
  let currentPath = 'inicio';
  let currentIndex = 0;
  const adminEmail = 'TU_CORREO@EJEMPLO.COM'; 

  const trackNames = {
    inicio: "Inicio",
    creation: "Creation Track",
    impact: "Impact Track",
    founder: "Founder Track"
  };

  const content = {
    inicio: [
        { title: 'Bienvenida', desc: 'Bienvenido al programa.', videoId: 'UIByRox2g6k' },
        { title: 'El valor del autoaprendizaje', desc: 'Reflexiones fundamentales.', videoId: 'gq8MR_JuRG0' },
        { title: 'Rituales y espacios para compartir', desc: 'Whatsapp para notificar, aquí para compartir y Discord para algo más informal', videoId: 'xwDVf97Hf58' },
    ],
    creation: [
        { title: 'Setup Builders', 
        desc: 'Las herramientas que usaremos ahora, instalar o crear cuenta en este orden: <a href="https://github.com" target="_blank" class="text-creation-gold underline"> 1. GitHub, es el respositorio de todo tu código </a>,  <a href="https://code.visualstudio.com" target="_blank" class="text-creation-gold underline"> 2. Visual Studio Code, usa tu cuenta de Github para darte de alta en Visual Code</a> <a href="https://vercel.com/" target="_blank" class="text-creation-gold underline">   3. Vercel, lo que permitirá que se pueda ver online. Date de alta con tu cuenta de Github</a>', videoId: 'wlajYcIHipA' },
        { title: 'La IA es el peor diseñador gráfico', 
        desc: 'Las promesas de la IA como diseñador gráfico son irreales cuando no eres sensible al diseño, recomiendo intentar personalizar el diseño de tu página web para que se siente más autentico <a href="https://www.figma.com/" target="_blank" class="text-creation-gold underline">Crear una cuenta en Figma</a>', 
        videoId: 'MPZw4RR_pyQ'  },
        { title: 'Figma Basicos', desc: 'Un básico de figma, si ya lo usas pasa este video', videoId: 'Ppxw3-dN7f8' },
        { title: 'Buscar inspiración', desc: 'Inpsiración visual para tu web <a href="https://www.cosmos.com" target="_blank" class="text-creation-gold underline">Cosmos</a> <a href="https//www.awwwards.com" target="_blank" class="text-creation-gold underline">Awwwards </a> <a href="https://www.dribbble.com" target="_blank" class="text-creation-gold underline">Dribbble</a>', videoId: 'XOCBoOAGWAE' },
        { title: 'De figma a código', desc: 'Pasar de tu diseño a código con la ayuda de Gemini IA <a href="https://gemini.google.com/" target="_blank" class="text-creation-gold underline">Gemini IA</a>', videoId: 'e83gC4oC8lI' },
       // { title: 'Estructura de una web', desc: 'Partes fundamentales de una web', videoId: 'J3j2bX9oK1o' },
        //{ title: 'Construyendo con Astro', desc: 'Construcción de la web con Astro.js <a href="https://astro.build/" target="_blank" class="text-creation-gold underline">Astro.js</a>', videoId: 'J1j1jYk9b0o' },
        //{ title: 'Despliegue con Vercel', desc: 'Despliegue de la web con Vercel <a href="https://vercel.com/" target="_blank" class="text-creation-gold underline">Vercel</a>', videoId: 'to1oX1bX1yA' },
      ],

    impact: [
      { title: 'Introducción a la ruta de impacto', desc: 'Porque la tecnología sola no cambiará el planeta, sino el conocimientos de los problemas', videoId: 's4EGhfWoFR4' }
    ],
    founder: [
      { title: 'Llenate de preguntas antes de fundar', desc: 'Mentalidad de creador.', videoId: '1Z2XFq1BrYA' }
    ],
  };

  // --- LÓGICA DE VIDEO ---
  window.playVideo = (path, idx) => {
    currentPath = path;
    currentIndex = idx;
    const item = content[path][idx];
    currentVideoId = item.videoId;

    player.source = { type: 'video', sources: [{ src: item.videoId, provider: 'youtube' }] };
    
    // Actualización Breadcrumb
    document.getElementById('v-track-label').innerText = trackNames[path] || path;
    document.getElementById('v-index-label').innerText = `Lección ${idx + 1}`;
    
    document.getElementById('v-title').innerText = item.title;
    document.getElementById('v-desc').innerHTML = item.desc;

    const nextBtn = document.getElementById('next-video-btn');
    if (idx >= content[path].length - 1) nextBtn.classList.add('hidden');
    else nextBtn.classList.remove('hidden');

    renderPath(path);
    loadComments(currentVideoId);
  };

  function renderPath(pathKey) {
    const container = document.getElementById('path-container');
    if (!container) return;
    container.innerHTML = content[pathKey].map((c, i) => `
      <button onclick="window.playVideo('${pathKey}', ${i})" class="video-card w-full text-left p-3 rounded-2xl flex items-center gap-3 group ${i === currentIndex ? 'bg-white/5 border border-white/10' : ''}">
        <div class="w-6 h-6 rounded-full ${i === currentIndex ? 'bg-creation-gold text-black' : 'bg-white/5 text-creation-gold'} flex items-center justify-center text-[8px] font-bold group-hover:bg-creation-gold group-hover:text-black transition-all shrink-0">${i+1}</div>
        <h4 class="text-[12px] font-bold ${i === currentIndex ? 'text-creation-gold' : 'text-white/70'} group-hover:text-white">${c.title}</h4>
      </button>
    `).join('');
  }

  // --- COMUNIDAD Y PERFIL ---
  async function loadCommunity() {
    const grid = document.getElementById('community-grid');
    const { data } = await supabase.from('profiles').select('*').not('full_name', 'is', null).order('updated_at', { ascending: false });
    grid.innerHTML = data?.map(p => `
      <div class="bg-white/[0.02] border border-white/5 p-6 rounded-[32px] hover:border-creation-gold/30 transition-all group">
        <div class="flex justify-between items-start mb-4">
          <div class="w-12 h-12 rounded-2xl bg-creation-gold/10 flex items-center justify-center text-creation-gold font-bold">${p.full_name?.substring(0,2).toUpperCase()}</div>
          ${p.linkedin_url ? `<a href="${p.linkedin_url}" target="_blank" class="text-white/20 hover:text-creation-gold transition-colors"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg></a>` : ''}
        </div>
        <h3 class="text-lg font-serif italic text-white group-hover:text-creation-gold">${p.full_name}</h3>
        <p class="text-[10px] uppercase text-creation-gold/60 font-bold mb-3">${p.bio || 'Builder'}</p>
        <p class="text-sm text-white/70 italic border-t border-white/5 pt-4 line-clamp-3">${p.project_description || 'En el track...'}</p>
      </div>
    `).join('') || '';
  }

  async function loadComments(videoId) {
    const container = document.getElementById('comments-container');
    const { data } = await supabase.from('comments').select(`id, content, created_at, user_id, profiles ( full_name )`).eq('video_id', videoId).order('created_at', { ascending: false });
    container.innerHTML = data?.map(c => `
      <div class="flex gap-4 group border-b border-white/5 pb-4">
        <div class="w-10 h-10 rounded-full bg-creation-gold/10 flex items-center justify-center shrink-0 text-[10px] text-creation-gold font-bold">${c.profiles?.full_name?.substring(0,2).toUpperCase() || '??'}</div>
        <div class="flex-1">
          <div class="flex items-center justify-between">
            <p class="text-[11px] font-bold text-creation-gold/80">${c.profiles?.full_name || 'Builder'}</p>
            ${(c.user_id === currentUserId || currentUserEmail === adminEmail) ? `<button onclick="deleteComment('${c.id}')" class="text-[9px] text-red-400/50 hover:text-red-400 opacity-0 group-hover:opacity-100">ELIMINAR</button>` : ''}
          </div>
          <p class="text-sm text-white/70 mt-1">${c.content}</p>
        </div>
      </div>
    `).join('') || '';
  }

  // --- INICIALIZACIÓN ---
  async function init() {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) return window.location.assign('/login');
    currentUserId = session.user.id;
    currentUserEmail = session.user.email ?? '';
    document.getElementById('dashboard-content').classList.remove('hidden');
    document.getElementById('user-email-display').innerText = currentUserEmail;
    
    player = new Plyr('#player', { controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'fullscreen'] });
    
    window.playVideo('inicio', 0);

    const { data: p } = await supabase.from('profiles').select('*').eq('id', currentUserId).single();
    if (p) {
        document.getElementById('profile-name').value = p.full_name || '';
        document.getElementById('profile-bio').value = p.bio || '';
        document.getElementById('profile-project').value = p.project_description || '';
        document.getElementById('profile-linkedin').value = p.linkedin_url || '';
    }
  }

  init();

  // --- LISTENERS ---
  document.querySelectorAll('.path-tab').forEach(tab => {
    tab.addEventListener('click', (e) => {
      const path = e.target.dataset.path;
      document.querySelectorAll('.path-tab').forEach(t => t.classList.remove('active'));
      e.target.classList.add('active');
      document.getElementById('view-learning').classList.add('hidden');
      document.getElementById('view-perfil').classList.add('hidden');
      document.getElementById('view-comunidad').classList.add('hidden');

      if (path === 'perfil') document.getElementById('view-perfil').classList.remove('hidden');
      else if (path === 'comunidad') { document.getElementById('view-comunidad').classList.remove('hidden'); loadCommunity(); }
      else { document.getElementById('view-learning').classList.remove('hidden'); window.playVideo(path, 0); }
    });
  });

  // --- LISTENERS DE INTERACCIÓN ---
document.getElementById('next-video-btn')?.addEventListener('click', () => {
  const nextIndex = currentIndex + 1;
  // Verificamos si existe una siguiente lección en el track actual
  if (content[currentPath] && content[currentPath][nextIndex]) {
    window.playVideo(currentPath, nextIndex);
    
    // Opcional: Hacer scroll hacia arriba para ver el nuevo video (útil en móvil)
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
});

  document.getElementById('update-profile-data')?.addEventListener('click', async () => {
    const msg = document.getElementById('profile-msg');
    const newPass = document.getElementById('profile-password').value;

    // Actualizar perfil
    const { error: profileError } = await supabase.from('profiles').upsert({
      id: currentUserId,
      full_name: document.getElementById('profile-name').value,
      bio: document.getElementById('profile-bio').value,
      project_description: document.getElementById('profile-project').value,
      linkedin_url: document.getElementById('profile-linkedin').value,
      updated_at: new Date()
    });

    // Actualizar contraseña si hay contenido
    if (newPass.length >= 6) {
      const { error: passError } = await supabase.auth.updateUser({ password: newPass });
      if (passError) { msg.innerText = "Error Contraseña (mín. 6 caracteres)"; msg.classList.remove('hidden'); return; }
    }

    msg.innerText = profileError ? "Error" : "✓ Perfil Actualizado";
    msg.classList.remove('hidden');
    document.getElementById('profile-password').value = '';
  });

  document.getElementById('send-comment')?.addEventListener('click', async () => {
    const input = document.getElementById('comment-input');
    if (!input.value.trim()) return;
    await supabase.from('comments').insert([{ video_id: currentVideoId, content: input.value, user_id: currentUserId, user_email: currentUserEmail }]);
    input.value = '';
    loadComments(currentVideoId);
  });

  document.getElementById('logout')?.addEventListener('click', async () => {
    await supabase.auth.signOut();
    window.location.assign('/login');
  });

  window.deleteComment = async (id) => {
    if (confirm("¿Borrar?")) { await supabase.from('comments').delete().eq('id', id); loadComments(currentVideoId); }
  };
</script>

<style is:global>
  :root { --plyr-color-main: #D4AF37; }
  .path-tab { @apply text-[10px] uppercase tracking-widest font-bold text-white/30 transition-all border-b-2 border-transparent pb-1 cursor-pointer hover:text-white/60 shrink-0; }
  .path-tab.active { @apply text-creation-gold border-creation-gold; }
  .custom-scrollbar::-webkit-scrollbar { width: 4px; }
  .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(212, 175, 55, 0.2); border-radius: 10px; }
  .no-scrollbar::-webkit-scrollbar { display: none; }
</style>